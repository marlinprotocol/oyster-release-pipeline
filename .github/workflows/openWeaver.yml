name: Build OpenWeaver
on:
  workflow_dispatch:
   inputs:
    beacon-version:
     description: 'beacon binary version'
     required: false
     default: 'X.Y.Z-beta.U'
    eth_relay-version:
     description: 'eth_relay binary version'
     required: false
     default: 'X.Y.Z-beta.U'
    gateway_eth-version:
     description: 'gateway_eth binary version'
     required: false
     default: 'X.Y.Z-beta.U'
    near_gateway-version:
     description: 'near_gateway binary version'
     required: false
     default: 'X.Y.Z-beta.U'
    iris_bridge-version:
     description: 'iris_bridge binary version'
     required: false
     default: 'X.Y.Z-beta.U'
jobs: 
  build_openweaver_linux:
    name: Build openWeaver linux
    strategy:
      matrix:
        include:
        - os: 'ubuntu-18.04'
          build_type: Release
          GOOS: linux
          GOARCH: amd64
    runs-on: ${{ matrix.os }}
    outputs:
      beacon_checksum: ${{steps.beacon.outputs.checksum}}
    steps:
    - uses: actions/checkout@v2
      with:
        ref: master
        repository: marlinprotocol/OpenWeaver
        submodules: recursive
    - name: install doxygen
      run: sudo apt-get install doxygen
    - name: install graphviz dot
      run: sudo apt install graphviz
    - name: Build folder
      run: mkdir build
    - name: CMake
      run: cd build && cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1
    - name: Make beacon
      id: beacon
      if: ${{github.event.inputs.beacon-version != 'X.Y.Z-beta.U'}}
      run: |
        cd build && make -j4 beacon_all
        echo "::set-output name=checksum::$(md5sum beacon/beacon | awk '{print $1;}')"
        mv beacon/beacon beacon/beacon-${{matrix.GOOS}}_${{matrix.GOARCH}}
        aws s3 cp beacon/beacon-${{matrix.GOOS}}_${{matrix.GOARCH}} s3://beta.artifacts.marlin.pro/projects/beacon/${{github.event.inputs.beacon-version}}/
    - name: Make eth_relay
      if: ${{github.event.inputs.eth_relay-version != 'X.Y.Z-beta.U'}}
      run: |
        cd build && make -j4 eth_relay
        mv relay/eth_relay relay/relay_eth-${{matrix.GOOS}}_${{matrix.GOARCH}}
        aws s3 cp relay/relay_eth-${{matrix.GOOS}}_${{matrix.GOARCH}} s3://beta.artifacts.marlin.pro/projects/relay_eth/${{github.event.inputs.eth_relay-version}}/
    - name: Make gateway_eth
      if: ${{github.event.inputs.gateway_eth-version != 'X.Y.Z-beta.U'}}
      run: |
        cd build && make -j4 onramp-eth
        mv integrations/eth/onramp_eth integrations/eth/gateway_eth-${{matrix.GOOS}}_${{matrix.GOARCH}}
        aws s3 cp integrations/eth/gateway_eth-${{matrix.GOOS}}_${{matrix.GOARCH}} s3://beta.artifacts.marlin.pro/projects/gateway_eth/${{github.event.inputs.gateway_eth-version}}/
    - name: Make near_gateway
      if: ${{github.event.inputs.near_gateway-version != 'X.Y.Z-beta.U'}}
      run: |
        cd build && make -j4 near_gateway
        mv integrations/near/near_gateway integrations/near/gateway_near-${{matrix.GOOS}}_${{matrix.GOARCH}}
        aws s3 cp integrations/near/gateway_near-${{matrix.GOOS}}_${{matrix.GOARCH}} s3://beta.artifacts.marlin.pro/projects/gateway_near/${{github.event.inputs.near_gateway-version}}/
    - name: Make iris_bridge
      if: ${{github.event.inputs.iris_bridge-version != 'X.Y.Z-beta.U'}}
      run: |
        cd build && make -j4 iris_bridge
        mv multicastsdk/iris_bridge multicastsdk/bridge_iris-${{matrix.GOOS}}_${{matrix.GOARCH}}
        aws s3 cp multicastsdk/bridge_iris-${{matrix.GOOS}}_${{matrix.GOARCH}} s3://beta.artifacts.marlin.pro/projects/gateway_iris/${{github.event.inputs.iris_bridge-version}}/
  
  build_abci-geth:
    if: ${{github.event.inputs.eth_relay-version != 'X.Y.Z-beta.U'}}
    name: Build abci-geth
    strategy:
      matrix:
        os: ['ubuntu-18.04']
        build_type: [Release]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v2
      with:
        ref: master
        repository: marlinprotocol/abci-geth
        submodules: recursive
    - name: Make
      run: make geth
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1
    - name: Upload
      run: |
       aws s3 cp build/bin/geth s3://beta.artifacts.marlin.pro/projects/relay_eth/${{github.event.inputs.eth_relay-version}}/geth-linux_amd64
       
  create-pr:
     name: create releases pr
     needs: build_openweaver_linux
     strategy:
      matrix:
        include:
        - os: 'ubuntu-18.04'
          build_type: Release
          GOOS: linux
          GOARCH: amd64
     runs-on: ${{ matrix.os }}
     steps:
     - uses: actions/checkout@v2
       with:
        token: ${{ secrets.PAT }}
        ref: beta
        repository: marlinprotocol/releases
        submodules: recursive
     - name: edit beacon
       if: ${{github.event.inputs.beacon-version != 'X.Y.Z-beta.U'}}
       run: |
         pip install semantic_version
         python script.py "projects/beacon/releases.json" ${{github.event.inputs.beacon-version}} "automated" beacon "s3://beta.artifacts.marlin.pro/projects/beacon/${{github.event.inputs.beacon-version}}//beacon-${{matrix.GOOS}}_${{matrix.GOARCH}}" "${{needs.build_openweaver_linux.outputs.beacon_checksum}}"
     - name: pr
       uses: peter-evans/create-pull-request@v3
       with:
          token: ${{ secrets.PAT }}
          branch: auto-beacon-${{github.event.inputs.beacon-version}}
          delete-branch: true
          title: 'Update Build'
